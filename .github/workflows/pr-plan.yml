name: PR Terraform Plan

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/**'
      - 'cluster-addons/**'
      - 'btcd-core/**'
      - 'Dockerfile'
      - 'scripts/**'

env:
  AWS_REGION: eu-west-1
  TF_VERSION: "1.9.0"

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # ============================================================
  # Layer 1: Infrastructure (runs first)
  # ============================================================
  plan-infra:
    name: Plan Infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: infra/deploy
        run: |
          terraform init \
            -backend-config="bucket=helos-dev-tfstate" \
            -backend-config="dynamodb_table=helos-dev-tflock"

      - name: Terraform Plan
        id: plan
        working-directory: infra/deploy
        run: |
          terraform plan -var-file="dev.tfvars" -no-color -out=tfplan 2>&1 | tee plan.txt
        continue-on-error: true

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infra/deploy/plan.txt', 'utf8');
            const truncated = plan.length > 60000 ? plan.substring(0, 60000) + '\n... (truncated)' : plan;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## üèóÔ∏è Infra Layer Plan\n\`\`\`hcl\n${truncated}\n\`\`\``
            });

      - name: Check Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

  # ============================================================
  # Layer 2: Cluster Addons (depends on infra)
  # ============================================================
  plan-cluster-addons:
    name: Plan Cluster Addons
    runs-on: ubuntu-latest
    needs: [plan-infra]  # Wait for infra plan
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: cluster-addons/deploy
        run: |
          terraform init \
            -backend-config="bucket=helos-dev-tfstate" \
            -backend-config="dynamodb_table=helos-dev-tflock"

      - name: Terraform Plan
        working-directory: cluster-addons/deploy
        run: terraform plan -var-file="dev.tfvars" -no-color
        continue-on-error: true

  # ============================================================
  # Layer 3: Bitcoin Core (depends on cluster-addons)
  # ============================================================
  plan-btcd-core:
    name: Plan Bitcoin Core
    runs-on: ubuntu-latest
    needs: [plan-cluster-addons]  # Wait for cluster-addons plan
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: btcd-core/deploy
        run: |
          terraform init \
            -backend-config="bucket=helos-dev-tfstate" \
            -backend-config="dynamodb_table=helos-dev-tflock"

      - name: Terraform Plan
        working-directory: btcd-core/deploy
        run: terraform plan -var-file="dev.tfvars" -no-color
        continue-on-error: true
